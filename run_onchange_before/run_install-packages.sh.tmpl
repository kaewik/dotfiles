#!/bin/bash
set -e # Exit on error

# --- System Packages (Ubuntu/Debian) ---
{{ if (or (eq .chezmoi.osRelease.id "ubuntu") (eq .chezmoi.osRelease.id "debian")) -}}
echo "Ubuntu/Debian detected. Running bootstrap..."
# Use -qq for "quite quiet" output in devcontainers
sudo apt-get update -qq
sudo apt-get install -y build-essential clang libclang-dev unzip curl fzf
{{ end -}}

# --- Install Rust (rustup) ---
if ! command -v rustup &> /dev/null; then
    echo "Installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
else
    [[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"
fi

# --- Use Cargo to install Bob & Tree-sitter ---
if command -v cargo &> /dev/null; then
    # Install Bob if missing
    if ! command -v bob &> /dev/null; then
        echo "Installing Bob (Neovim Manager)..."
        cargo install bob-nvim
    fi

    # Install Tree-sitter if missing
    if ! command -v tree-sitter &> /dev/null; then
        echo "Installing Tree-sitter CLI..."
        cargo install tree-sitter-cli
    fi

    # Install ripgrep if missing
    if ! command -v rg &> /dev/null; then
        echo "Installing Ripgrep..."
        cargo install ripgrep
    fi

    # Install fd-find if missing
    if ! command -v fd &> /dev/null; then
        echo "Installing fd-find..."
        cargo install fd-find
    fi
fi

# --- Oh My Zsh ---
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "Installing Oh My Zsh..."
    # Keep it non-interactive
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# --- Powerlevel10k ---
P10K_DIR="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k"
if [ ! -d "$P10K_DIR" ]; then
    echo "Installing Powerlevel10k..."
    git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "$P10K_DIR"
fi

# --- Use Bob to install Neovim ---
if command -v bob &> /dev/null; then
    echo "Installing Neovim stable via Bob..."
    bob use stable

    # Optional: Ensure the bob proxy is initialized
    # This makes sure the 'nvim' command points to the version bob installed
    export PATH="$HOME/.local/share/bob/nvim-bin:$PATH"
fi

# load fonts
fc-cache -fv
